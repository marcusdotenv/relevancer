version: '3'

services:

  cache:
    image: redis:latest
    hostname: redis
    ports:
      - "6379:6379"

  api:
    build: 
      context: ./api
      dockerfile: dockerfile.dev
    ports:
      - "8000:8000"
    environment:
      - ENV=production
      - DATABASE_HOST=db
      - DATABASE_PORT=5432
      - DATABASE_USER=dev
      - DATABASE_PASSWD=dev
      - DATABASE_NAME=trie
      - CACHE_HOST=cache
      - CACHE_PORT=6379
      - LOG_SOURCE_URL=http://loki:3100
      - TERM_FILE_STORAGE_URL=http://localstack:4566
    volumes:
      - ./api:/app # enable development with hot reload 
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      - cache
      - localstack

  loki:
    image: grafana/loki:latest
    ports:
      - "3100:3100"
    logging:
      driver: "none" 

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=dev
      - GF_SECURITY_ADMIN_PASSWORD=dev
    depends_on:
      - loki
    volumes:
      - ./config/grafana/provisioning:/etc/grafana/provisioning
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards
    logging:
      driver: "none" 

  localstack:
    image: localstack/localstack
    ports:
      - "4566:4566" 
      - "4510-4559:4510-4559" 
      - "8080:8080"
    environment:
      - SERVICES=s3 
    volumes:
      - ./config/localstack/init:/etc/localstack/init

  localstack-infra-starter:
    image: amazon/aws-cli
    depends_on:
      - localstack
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
    volumes:
      - ./config/localstack/init:/etc/localstack/init 
    entrypoint: ["/bin/sh", "-c", "chmod +x /etc/localstack/init/create_bucket.sh && /etc/localstack/init/create_bucket.sh"]
